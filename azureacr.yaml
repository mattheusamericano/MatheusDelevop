name: ACR Login and Push
description: 'Login and Push in the Docker Registry'
inputs:
  destination_acr_name:
    required: true
    type: string
  client_id_runner:
    required: true
    type: string
  origin_acr_name:
    required: true
    type: string

runs:
  using: composite
  steps:
    - name: Login on Azure
      run: |
        az login --identity --client-id ${{ inputs.client_id_runner }}
      shell: bash

    - name: Connecting on destination Registry
      run: |
        USERNAME="00000000-0000-0000-0000-000000000000"
        TOKEN=$(az acr login --name ${{ inputs.destination_acr_name }} --expose-token --output tsv --query accessToken)
        sudo docker login ${{ inputs.destination_acr_name }}.azurecr.io --username $USERNAME --password-stdin <<< $TOKEN
      shell: bash

    - name: Get Image Digest and Import
      run: |
        # Obter o digest da imagem de origem
        SOURCE_DIGEST=$(az acr repository show-manifests --name ${{ inputs.origin_acr_name }} --repository ${{ env.image_dir }} --query "[?tags[0]=='${{ env.image_tag }}'].digest" -o tsv)
        
        # Verificar se o digest foi encontrado
        if [ -z "$SOURCE_DIGEST" ]; then
          echo "Error: Could not find digest for image ${{ env.image_dir }}:${{ env.image_tag }}"
          exit 1
        fi
        
        # Fazer o import usando o digest
        az acr import --name ${{ inputs.destination_acr_name }} --source ${{ inputs.origin_acr_name }}.azurecr.io/${{ env.image_dir }}@$SOURCE_DIGEST --image ${{ env.image_dir }}:${{ env.image_tag }}
        
        # Verificar se o import foi bem-sucedido
        echo "Import completed successfully!"
        echo "Image: ${{ env.image_dir }}:${{ env.image_tag }}"
        echo "Source digest: $SOURCE_DIGEST"
        echo "Destination: ${{ inputs.destination_acr_name }}.azurecr.io/${{ env.image_dir }}:${{ env.image_tag }}"
      shell: bash
