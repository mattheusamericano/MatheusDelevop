steps:
- task: Bash@3
  condition: and(succeeded(), not(startsWith(variables['Build.SourceBranch'], 'refs/heads/destroy-')))
  displayName: "Create RG + COS bucket (with checks)"
  inputs:
    targetType: 'inline'
    script: |
      set -eo pipefail

      PROJ_RAW          ="$(project)"
      ENV_RAW           ="$(environment)"
      REGION            ="$(region)"
      PLAN              ="$(state_plan)"
      SERVICE_ENDPOINT  ="$(state_service_endpoint_name)"
      COS_BUCKET        ="$(state_bucket)"
      COS_ENDPOINT_TYPE ="$(state_endpoint_type)"; [ -n "$COS_ENDPOINT_TYPE" ] || COS_ENDPOINT_TYPE="direct"

      [ -n "$PROJ_RAW" ]         || { echo "ERRO: 'project' n√£o definido."; exit 1; }
      [ -n "$ENV_RAW" ]          || { echo "ERRO: 'environment' n√£o definido."; exit 1; }
      [ -n "$REGION" ]           || { echo "ERRO: 'region' n√£o definido."; exit 1; }
      [ -n "$PLAN" ]             || { echo "ERRO: 'state_plan' n√£o definido."; exit 1; }
      [ -n "$SERVICE_ENDPOINT" ] || { echo "ERRO: 'state_service_endpoint_name' n√£o definido."; exit 1; }
      [ -n "$COS_BUCKET" ]       || { echo "ERRO: 'state_bucket' n√£o definido."; exit 1; }

      slug                  =$(echo "$PROJ_RAW" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g; s/^-+|-+$//g' | cut -c1-50)
      env_lc                =$(echo "$ENV_RAW" | tr '[:upper:]' '[:lower:]')
      RG_NAME               ="rg-${slug}-${env_lc}"
      COS_ENDPOINT          ="s3.${COS_ENDPOINT_TYPE}.${REGION}.cloud-object-storage.appdomain.cloud"
      COS_INSTANCE_NAME     ="cos-${slug}-${env_lc}"

      echo "Projeto:        $PROJ_RAW ‚Üí $slug"
      echo "Ambiente:       $ENV_RAW  ‚Üí $env_lc"
      echo "Resource Group: $RG_NAME"
      echo "COS bucket:     $COS_BUCKET"
      echo "Inst√¢ncia COS:  $COS_INSTANCE_NAME"
      echo "Regi√£o bucket:  $REGION"
      echo "Plano COS:      $PLAN"
      echo "Deployment COS: $SERVICE_ENDPOINT"
      echo "Endpoint COS:   $COS_ENDPOINT"

      echo "üîß Instalando IBM Cloud CLI (se necess√°rio)..."
      if ! command -v ibmcloud >/dev/null 2>&1; then
        curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
      fi
      if ! ibmcloud plugin list | grep -q 'cloud-object-storage'; then
        ibmcloud plugin install cloud-object-storage -f
      fi

      echo "Login na IBM Cloud..."
      ibmcloud login --apikey "${IBMCLOUD-API-KEY}" -r "$REGION" -q

      echo "Verificando se Resource Group '$RG_NAME' j√° existe..."
      if ibmcloud resource groups | grep -q "$RG_NAME"; then
        echo "Resource Group '$RG_NAME' j√° existe. Pulando cria√ß√£o."
      else
        echo "Criando Resource Group: $RG_NAME"
        ibmcloud resource group-create "$RG_NAME"
      fi

      echo "Target no Resource Group..."
      ibmcloud target -g "$RG_NAME"

      echo "Verificando/instanciando servi√ßo COS..."
      if ! ibmcloud resource service-instances --output json | jq -e ".[] | select(.name==\"$COS_INSTANCE_NAME\")" >/dev/null; then
        echo "Criando inst√¢ncia COS: $COS_INSTANCE_NAME (plano $PLAN)"
        ibmcloud resource service-instance-create "$COS_INSTANCE_NAME" cloud-object-storage "$PLAN" global -g "$RG_NAME" --deployment "$SERVICE_ENDPOINT"
      else
        echo "Inst√¢ncia COS j√° existe: $COS_INSTANCE_NAME"
      fi

      echo "‚öôÔ∏è Configurando COS CLI..."
      COS_INSTANCE_CRN=$(ibmcloud resource service-instance "$COS_INSTANCE_NAME" --output json | jq -r '.[0].crn')
      ibmcloud cos config crn --crn "$COS_INSTANCE_CRN"
      ibmcloud cos config region --region "$REGION"

      echo "Criando bucket: $COS_BUCKET (se necess√°rio)..."
      if ! ibmcloud cos bucket-head --bucket "$COS_BUCKET" >/dev/null 2>&1; then
        ibmcloud cos bucket-create --bucket "$COS_BUCKET" --region "$REGION" --class smart
      else
        echo "Bucket j√° existe: $COS_BUCKET"
      fi

      echo "Pr√©-requisitos finalizados com sucesso."
